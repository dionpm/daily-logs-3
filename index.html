<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Daily Test Log</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f1320">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root{--bg:#0f1320;--card:#161a2b;--ink:#e8eaf6;--muted:#a6accd;--accent:#8ab4f8;--border:#2a3152;--danger:#ff6b6b;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  nav.tabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0e1221;color:var(--ink);cursor:pointer}
  .tab.active{background:#1a2040;border-color:#3a4370}
  .wrap{max-width:1200px;margin:0 auto;padding:12px;display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:900px){ .wrap{grid-template-columns:360px 1fr;} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .card h2{font-size:16px;margin:0 0 8px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e1221;color:var(--ink)}
  option{color:#000}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
  .toolbar > div{flex:1;min-width:160px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .note{font-size:12px;color:var(--muted)}
  .warn{color:#ffd7d7}
  .hint{font-size:12px;color:#ffd28a}
  .debug{background:#221d00;color:#ffe08a;border:1px dashed #ffe08a;border-radius:10px;padding:8px;margin:8px 0;display:none}
  table{width:100%;border-collapse:collapse;background:#0d1120;border:1px solid var(--border)}
  th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;font-size:13px}
  th{background:#11162a;color:#c7ceea;position:sticky;top:0;z-index:1}
  thead th.group{background:#10162b;font-weight:700}
  .sticky-col{position:sticky;left:0;background:#10162b;z-index:2}
  .cell{min-width:64px}
  .cell[contenteditable="true"]{outline:none}
  .cell:focus{box-shadow:0 0 0 2px var(--accent) inset}
  .danger{border-color:var(--danger); color:#ffd7d7}
  @media print{
    body{background:#fff;color:#000}
    header,.no-print{display:none!important}
    .wrap{grid-template-columns:1fr}
    .card{border:none;padding:0}
    th,td{border:1px solid #777;color:#000}
    th{background:#eee;color:#000}
    .sticky-col{position:static;background:#fff}
  }
  /* Daily grid styling */
  .dayGrid th{position:static}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0e1221;font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>Daily Test Log</h1>
    <span id="warn" class="note warn"></span>
  </header>

  <nav class="tabs no-print">
    <button id="tabDaily" class="tab active">Daily</button>
    <button id="tabMonthly" class="tab">Monthly</button>
  </nav>

  <div class="wrap">
    <!-- LEFT: Setup + Edit (shared) -->
    <section class="card">
      <h2>Setup</h2>
      <div class="toolbar">
        <div>
          <label for="systemSel">System</label>
          <select id="systemSel"><option value="" disabled selected>-- Select System --</option></select>
          <div id="sysEmptyHint" class="hint" style="display:none;margin-top:6px">
            No systems yet. Click <b>Edit Systems</b> below to add one.
          </div>
          <div id="debugBox" class="debug">
            <div><b>Config is empty/corrupted.</b></div>
            <div class="actions" style="margin-top:8px">
              <button id="btnSeed">Seed Defaults</button>
              <button id="btnReset">Force Reset (clear storage & cache)</button>
            </div>
          </div>
        </div>
        <div id="dailyInputs">
          <label for="dateSel">Date</label>
          <input type="date" id="dateSel" />
          <div class="actions">
            <button id="prevDay">◀ Prev</button>
            <button id="nextDay">Next ▶</button>
          </div>
        </div>
        <div id="monthlyInputs" style="display:none">
          <label for="monthSel">Month</label>
          <input type="month" id="monthSel" />
          <div class="actions">
            <button id="btnBuild">Build Grid</button>
          </div>
        </div>
      </div>

      <hr style="border-color:var(--border);margin:12px 0" />

      <h2 class="no-print">Import / Export</h2>
      <div class="actions no-print">
        <input type="file" id="importFile" accept=".json" />
        <button id="btnExportJSON">Export JSON</button>
        <button id="btnExportCSV">Export CSV</button>
        <button id="btnExportXLS">Export Excel</button>
        <button id="btnExportPDF">Export PDF</button>
        <button id="btnPrint">Print</button>
      </div>
      <p class="note">Tip: Add to Home Screen for offline use.</p>

      <hr style="border-color:var(--border);margin:12px 0" />

      <button id="toggleEdit">Edit Systems / Points / Fields</button>
      <div id="editPanel" style="display:none;margin-top:10px">
        <h3 style="margin:6px 0">Editing: <span id="editingSystemName"></span></h3>
        <div class="row">
          <div>
            <h3 style="margin:8px 0">Systems</h3>
            <div class="actions"><input id="newSystem" placeholder="Add new system" /><button id="addSystem">Add</button></div>
            <ul id="sysList" style="list-style:none;padding-left:0;margin:8px 0"></ul>
          </div>
          <div>
            <h3 style="margin:8px 0">For Selected System</h3>
            <div class="actions"><input id="newPoint" placeholder="Add test point to this system" /><button id="addPoint">Add</button></div>
            <ul id="pointList" style="list-style:none;padding-left:0;margin:8px 0"></ul>
            <div class="actions"><input id="newField" placeholder="Add field to this system" /><button id="addField">Add</button></div>
            <ul id="fieldList" style="list-style:none;padding-left:0;margin:8px 0"></ul>
          </div>
        </div>
        <div class="actions"><button id="doneEdit">Done</button></div>
      </div>
    </section>

    <!-- RIGHT: Views -->
    <section class="card" id="viewDaily">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 id="dayTitle">Daily View</h2>
        <span id="statusDaily" class="note"></span>
      </div>
      <div id="dayWrap" style="overflow:auto;max-height:70vh"></div>
      <p class="note no-print" style="margin-top:8px">Edit cells for this day; it auto-saves to the same database the monthly view uses.</p>
    </section>

    <section class="card" id="viewMonthly" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 id="gridTitle">Monthly View</h2>
        <span id="statusMonthly" class="note"></span>
      </div>
      <div id="gridWrap" style="overflow:auto;max-height:70vh"><table id="grid"></table></div>
      <p class="note no-print" style="margin-top:8px">Tap a cell to edit; it auto-saves.</p>
    </section>
  </div>

<script>
/* ===== Service worker (optional) ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(function(e){ /* ignore */ });
  });
}

/* ===== Helpers ===== */
function storageAvailable(type){try{var s=window[type],x='__t__';s.setItem(x,x);s.removeItem(x);return true;}catch(e){return false;}}
const HAS_LS = storageAvailable('localStorage');
document.getElementById('warn').textContent = HAS_LS ? '' : 'Private mode may limit saving.';

function deepCopy(o){ return JSON.parse(JSON.stringify(o)); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ===== Keys & Seed ===== */
const CONFIG_KEY='cfg_v2';
const DATA_KEY='db_v2';
const SEED = {
  systems: ["Cooling Tower #1","Cooling Tower #2","Central Chilled Water","Central Hot Water","B Condensate Return","J Condensate Return","J Boiler - Laundry","J2 Boiler - Food Factory"],
  bySystem: {
    "Cooling Tower #1":{points:["Basin","Return","Makeup"], fields:["pH","ORP","M","Total Hardness","PTSA","Conductivity","Chemical Added","Comments"]},
    "Cooling Tower #2":{points:["Basin","Return","Makeup"], fields:["pH","ORP","M","Total Hardness","PTSA","Conductivity","Chemical Added","Comments"]},
    "Central Chilled Water":{points:["Supply"], fields:["Nitrite","TD","pH","Hardness","Chemical Added","Comments"]},
    "Central Hot Water":{points:["Supply"], fields:["Nitrite","TD","pH","Hardness","Chemical Added","Comments"]},
    "B Condensate Return":{points:["East","West"], fields:["pH","Total Hardness","Conductivity (µS/cm)"]},
    "J Condensate Return":{points:["Sample"], fields:["pH","Total Hardness","Conductivity (µS/cm)"]},
    "J Boiler - Laundry":{points:["Feedwater","Boiler Water","Blowdown"], fields:["Gallons","Manual Blowdown","CBD %","Softener #","Chlorine","Total Hardness","Alkalinity","pH","Sulfite","Conductivity","Phosphate","DEHA","Return Hardness","Comments"]},
    "J2 Boiler - Food Factory":{points:["Feedwater","Boiler Water","Blowdown"], fields:["Gallons","Manual Blowdown","CBD %","Softener #","Chlorine","Total Hardness","Alkalinity","pH","Sulfite","Conductivity","Phosphate","DEHA","Return Hardness","Comments"]}
  }
};

/* ===== State ===== */
let CONFIG = null; let DB = {};
try{ const c=localStorage.getItem(CONFIG_KEY); if(c) CONFIG=JSON.parse(c); const d=localStorage.getItem(DATA_KEY); if(d) DB=JSON.parse(d);}catch(e){}
function isValidConfig(cfg){ return cfg && Array.isArray(cfg.systems) && cfg.systems.length>0 && cfg.bySystem && typeof cfg.bySystem==='object'; }
const debugBox=document.getElementById('debugBox');
if(!isValidConfig(CONFIG)){ CONFIG = deepCopy(SEED); try{ localStorage.setItem(CONFIG_KEY, JSON.stringify(CONFIG)); }catch(e){} }
if(!isValidConfig(CONFIG)){ debugBox.style.display='block'; }

function saveAll(){ try{ localStorage.setItem(CONFIG_KEY, JSON.stringify(CONFIG)); localStorage.setItem(DATA_KEY, JSON.stringify(DB)); }catch(e){} }
window.saveAll = saveAll;

/* ===== UI Elements ===== */
const systemSel=document.getElementById('systemSel');
const dateSel=document.getElementById('dateSel');
const monthSel=document.getElementById('monthSel');
const sysEmptyHint=document.getElementById('sysEmptyHint');

const tabDaily=document.getElementById('tabDaily');
const tabMonthly=document.getElementById('tabMonthly');
const viewDaily=document.getElementById('viewDaily');
const viewMonthly=document.getElementById('viewMonthly');
const dailyInputs=document.getElementById('dailyInputs');
const monthlyInputs=document.getElementById('monthlyInputs');

const dayWrap=document.getElementById('dayWrap');
const statusDaily=document.getElementById('statusDaily');
const grid=document.getElementById('grid');
const gridTitle=document.getElementById('gridTitle');
const statusMonthly=document.getElementById('statusMonthly');

const toggleEdit=document.getElementById('toggleEdit'); const editPanel=document.getElementById('editPanel'); const doneEdit=document.getElementById('doneEdit');
const editNameEl=document.getElementById('editingSystemName');
const sysList=document.getElementById('sysList'); const pointList=document.getElementById('pointList'); const fieldList=document.getElementById('fieldList');
const newSystem=document.getElementById('newSystem'); const addSystem=document.getElementById('addSystem');
const newPoint=document.getElementById('newPoint'); const addPoint=document.getElementById('addPoint');
const newField=document.getElementById('newField'); const addField=document.getElementById('addField');

const btnSeed=document.getElementById('btnSeed'); const btnReset=document.getElementById('btnReset');
const btnBuild=document.getElementById('btnBuild'); const importFile=document.getElementById('importFile');
const btnExportJSON=document.getElementById('btnExportJSON'); const btnExportCSV=document.getElementById('btnExportCSV');
const btnExportXLS=document.getElementById('btnExportXLS'); const btnExportPDF=document.getElementById('btnExportPDF'); const btnPrint=document.getElementById('btnPrint');
const prevDay=document.getElementById('prevDay'); const nextDay=document.getElementById('nextDay');

/* ===== Basic UI ===== */
function refreshSystemSelect(){
  const has = CONFIG.systems && CONFIG.systems.length>0;
  if(!has){
    systemSel.innerHTML = '<option value="" disabled selected>-- No systems --</option>';
    sysEmptyHint.style.display='block'; debugBox.style.display='block';
  } else {
    var opts = ['<option value="" disabled selected>-- Select System --</option>'];
    CONFIG.systems.forEach(function(s){ opts.push('<option>'+s+'</option>'); });
    systemSel.innerHTML = opts.join('');
    sysEmptyHint.style.display='none'; debugBox.style.display='none';
  }
}

function setActiveTab(which){
  if(which==='daily'){
    tabDaily.classList.add('active'); tabMonthly.classList.remove('active');
    viewDaily.style.display='block'; viewMonthly.style.display='none';
    dailyInputs.style.display='block'; monthlyInputs.style.display='none';
  } else {
    tabMonthly.classList.add('active'); tabDaily.classList.remove('active');
    viewMonthly.style.display='block'; viewDaily.style.display='none';
    monthlyInputs.style.display='block'; dailyInputs.style.display='none';
  }
}

tabDaily.addEventListener('click', function(){ setActiveTab('daily'); renderDaily(); });
tabMonthly.addEventListener('click', function(){ setActiveTab('monthly'); if(systemSel.value&&monthSel.value){ buildMonthly(); } });

/* ===== DAILY VIEW ===== */
function statusD(msg){ statusDaily.textContent=msg; setTimeout(function(){statusDaily.textContent='';},1200); }
function ymd(date){ return date.toISOString().slice(0,10); }
function addDaysStr(ymdStr, delta){
  var d=new Date(ymdStr); d.setDate(d.getDate()+delta);
  var m=d.getMonth()+1; var day=d.getDate();
  return d.getFullYear()+'-'+String(m).padStart(2,'0')+'-'+String(day).padStart(2,'0');
}

function renderDaily(){
  var sys=systemSel.value; var day=dateSel.value;
  if(!sys || !day){ dayWrap.innerHTML='<p class="note">Pick a System and Date.</p>'; return; }
  var cfg = CONFIG.bySystem[sys] || {points:["Point 1"], fields:["Value"]};
  var points=cfg.points.slice(), fields=cfg.fields.slice();
  var ym = day.slice(0,7); var dd = day.slice(8,10);

  // Build a single-day table (Points × Fields)
  var html = '<table class="dayGrid"><thead><tr><th class="sticky-col">Point</th>';
  fields.forEach(function(f){ html += '<th>'+esc(f)+'</th>'; });
  html += '</tr></thead><tbody>';
  points.forEach(function(pt){
    html += '<tr><th class="sticky-col">'+esc(pt)+'</th>';
    fields.forEach(function(fd){
      var val = (DB[sys]&&DB[sys][ym]&&DB[sys][ym][dd]&&DB[sys][ym][dd][pt]&&DB[sys][ym][dd][pt][fd]) || '';
      html += '<td class="cell" contenteditable="true" data-point="'+esc(pt)+'" data-field="'+esc(fd)+'">'+esc(val)+'</td>';
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  dayWrap.innerHTML = html;

  // Title
  document.getElementById('dayTitle').innerHTML = 'Daily View — <span class="pill">'+esc(sys)+'</span> — <span class="pill">'+esc(day)+'</span>';

  // Wire edits
  var cells = dayWrap.querySelectorAll('.cell');
  for(var i=0;i<cells.length;i++){
    cells[i].addEventListener('blur', function(ev){
      var td=ev.currentTarget, pt=td.getAttribute('data-point'), fd=td.getAttribute('data-field'), val=td.textContent.trim();
      DB[sys]=DB[sys]||{}; DB[sys][ym]=DB[sys][ym]||{}; DB[sys][ym][dd]=DB[sys][ym][dd]||{}; DB[sys][ym][dd][pt]=DB[sys][ym][dd][pt]||{};
      DB[sys][ym][dd][pt][fd]=val; saveAll(); statusD('Saved');
    });
  }
}

/* Prev/Next day buttons */
prevDay.addEventListener('click', function(){
  if(!dateSel.value) return;
  dateSel.value = addDaysStr(dateSel.value, -1);
  renderDaily();
});
nextDay.addEventListener('click', function(){
  if(!dateSel.value) return;
  dateSel.value = addDaysStr(dateSel.value, +1);
  renderDaily();
});

/* ===== MONTHLY VIEW ===== */
function statusM(msg){ statusMonthly.textContent=msg; setTimeout(function(){statusMonthly.textContent='';},1200); }
function buildMonthly(){
  var sys=systemSel.value; var ym=monthSel.value;
  if(!sys){ alert('Pick a system'); return; }
  if(!ym){ alert('Pick a month (YYYY-MM)'); return; }

  var cfg = CONFIG.bySystem[sys] || {points:["Point 1"], fields:["Value"]};
  var points=cfg.points.slice(), fields=cfg.fields.slice();
  var days = new Date(+ym.slice(0,4), +ym.slice(5,7), 0).getDate();

  DB[sys]=DB[sys]||{}; DB[sys][ym]=DB[sys][ym]||{};
  gridTitle.textContent = sys + ' — ' + ym;

  var html = '<thead><tr><th class="sticky-col">Day</th>';
  points.forEach(function(p){ html += '<th class="group" colspan="'+fields.length+'">'+esc(p)+'</th>'; });
  html += '</tr><tr><th class="sticky-col">Date</th>';
  points.forEach(function(p){ fields.forEach(function(f){ html += '<th>'+esc(f)+'</th>'; }); });
  html += '</tr></thead><tbody>';

  for(var d=1; d<=days; d++){
    var ds=String(d).padStart(2,'0'); var dateStr=ym+'-'+ds; var row=DB[sys][ym][ds]||{};
    html += '<tr data-day="'+ds+'"><th class="sticky-col">'+esc(dateStr)+'</th>';
    points.forEach(function(pt){
      var obj=row[pt]||{};
      fields.forEach(function(fd){
        var val = (obj[fd] != null) ? String(obj[fd]) : '';
        html += '<td class="cell" contenteditable="true" data-point="'+esc(pt)+'" data-field="'+esc(fd)+'">'+esc(val)+'</td>';
      });
    });
    html += '</tr>';
  }
  html += '</tbody>';
  grid.innerHTML = html;

  var cells = grid.querySelectorAll('.cell');
  for(var i=0;i<cells.length;i++){
    cells[i].addEventListener('blur', function(ev){
      var td=ev.currentTarget, day=td.closest('tr').getAttribute('data-day'), pt=td.getAttribute('data-point'), fd=td.getAttribute('data-field'), val=td.textContent.trim();
      DB[sys]=DB[sys]||{}; DB[sys][ym]=DB[sys][ym]||{}; DB[sys][ym][day]=DB[sys][ym][day]||{}; DB[sys][ym][day][pt]=DB[sys][ym][day][pt]||{};
      DB[sys][ym][day][pt][fd]=val; saveAll(); statusM('Saved');
    });
  }
}
window.buildMonthly = buildMonthly;

/* ===== Edit Config (same as before) ===== */
let activeSysForEdit = null;
function renderEdit(){
  if(!CONFIG.systems || CONFIG.systems.length===0){ activeSysForEdit = null; editNameEl.textContent = '(none)'; }
  else { activeSysForEdit = systemSel.value || CONFIG.systems[0]; editNameEl.textContent = activeSysForEdit; }
  sysList.innerHTML='';

  (CONFIG.systems||[]).forEach(function(s,i){
    var li=document.createElement('li');
    li.style.display='flex'; li.style.gap='6px'; li.style.alignItems='center'; li.style.marginBottom='6px';
    li.innerHTML = '<input value="'+esc(s)+'" data-i="'+i+'" class="sysName" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1221;color:#e8eaf6" />'
                 + '<button data-i="'+i+'" class="delSys danger" style="width:auto">Delete</button>';
    sysList.appendChild(li);
  });

  var cfg = activeSysForEdit ? (CONFIG.bySystem[activeSysForEdit] || {points:["Point 1"], fields:["Value"]}) : {points:[],fields:[]};
  pointList.innerHTML='';
  cfg.points.forEach(function(p,i){
    var li=document.createElement('li');
    li.style.display='flex'; li.style.gap='6px'; li.style.alignItems='center'; li.style.marginBottom='6px';
    li.innerHTML = '<input value="'+esc(p)+'" data-i="'+i+'" class="ptName" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1221;color:#e8eaf6" />'
                 + '<button data-i="'+i+'" class="delPoint danger" style="width:auto">Delete</button>';
    pointList.appendChild(li);
  });

  fieldList.innerHTML='';
  cfg.fields.forEach(function(f,i){
    var li=document.createElement('li');
    li.style.display='flex'; li.style.gap='6px'; li.style.alignItems='center'; li.style.marginBottom='6px';
    li.innerHTML = '<input value="'+esc(f)+'" data-i="'+i+'" class="fdName" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e1221;color:#e8eaf6" />'
                 + '<button data-i="'+i+'" class="delField danger" style="width:auto">Delete</button>';
    fieldList.appendChild(li);
  });
}

document.getElementById('toggleEdit').addEventListener('click', function(){
  editPanel.style.display = (editPanel.style.display==='none' || editPanel.style.display==='') ? 'block' : 'none';
  if(editPanel.style.display==='block') renderEdit();
});
doneEdit.addEventListener('click', function(){
  editPanel.style.display='none'; saveAll(); refreshSystemSelect();
  if(systemSel.value && monthSel.value) buildMonthly();
  if(systemSel.value && dateSel.value) renderDaily();
});

addSystem.addEventListener('click', function(){
  var name=newSystem.value.trim(); if(!name) return;
  if(!CONFIG.systems) CONFIG.systems=[];
  if(!CONFIG.bySystem) CONFIG.bySystem={};
  if(CONFIG.systems.indexOf(name)===-1){
    CONFIG.systems.push(name); CONFIG.bySystem[name]={points:["Point 1"], fields:["Value"]};
    newSystem.value=''; saveAll(); refreshSystemSelect(); renderEdit();
  }
});
sysList.addEventListener('click', function(ev){
  var btn=ev.target.closest('button.delSys'); if(!btn) return;
  var i=+btn.dataset.i; var name=CONFIG.systems[i];
  if(confirm('Delete system "'+name+'"?')){
    CONFIG.systems.splice(i,1); delete CONFIG.bySystem[name];
    if(activeSysForEdit===name){ activeSysForEdit=CONFIG.systems[0]||null; }
    saveAll(); refreshSystemSelect(); renderEdit();
  }
});
sysList.addEventListener('input', function(ev){
  var ip=ev.target.closest('input.sysName'); if(!ip) return;
  var i=+ip.dataset.i; var old=CONFIG.systems[i]; var neo=ip.value.trim();
  if(neo && neo!==old){
    CONFIG.systems[i]=neo; CONFIG.bySystem[neo]=CONFIG.bySystem[old]||{points:["Point 1"], fields:["Value"]};
    delete CONFIG.bySystem[old]; if(DB[old]){ DB[neo]=DB[old]; delete DB[old]; }
    if(activeSysForEdit===old){ activeSysForEdit=neo; }
    saveAll(); refreshSystemSelect();
  }
});
addPoint.addEventListener('click', function(){
  if(!activeSysForEdit){ alert('Add/select a system first.'); return; }
  var name=newPoint.value.trim(); if(!name) return;
  CONFIG.bySystem[activeSysForEdit]=CONFIG.bySystem[activeSysForEdit]||{points:[],fields:[]};
  CONFIG.bySystem[activeSysForEdit].points.push(name);
  newPoint.value=''; saveAll(); renderEdit();
  if(systemSel.value===activeSysForEdit && monthSel.value) buildMonthly();
  if(systemSel.value===activeSysForEdit && dateSel.value) renderDaily();
});
pointList.addEventListener('click', function(ev){
  var btn=ev.target.closest('button.delPoint'); if(!btn) return;
  var idx=+btn.dataset.i; var arr=CONFIG.bySystem[activeSysForEdit].points; var name=arr[idx];
  if(confirm('Delete point "'+name+'"?')){
    arr.splice(idx,1); saveAll(); renderEdit();
    if(systemSel.value===activeSysForEdit && monthSel.value) buildMonthly();
    if(systemSel.value===activeSysForEdit && dateSel.value) renderDaily();
  }
});
pointList.addEventListener('input', function(ev){
  var ip=ev.target.closest('input.ptName'); if(!ip) return;
  var idx=+ip.dataset.i; CONFIG.bySystem[activeSysForEdit].points[idx]=ip.value; saveAll();
  if(systemSel.value===activeSysForEdit && monthSel.value) buildMonthly();
  if(systemSel.value===activeSysForEdit && dateSel.value) renderDaily();
});
addField.addEventListener('click', function(){
  if(!activeSysForEdit){ alert('Add/select a system first.'); return; }
  var name=newField.value.trim(); if(!name) return;
  CONFIG.bySystem[activeSysForEdit]=CONFIG.bySystem[activeSysForEdit]||{points:[],fields:[]};
  CONFIG.bySystem[activeSysForEdit].fields.push(name);
  newField.value=''; saveAll(); renderEdit();
  if(systemSel.value===activeSysForEdit && monthSel.value) buildMonthly();
  if(systemSel.value===activeSysForEdit && dateSel.value) renderDaily();
});
fieldList.addEventListener('click', function(ev){
  var btn=ev.target.closest('button.delField'); if(!btn) return;
  var idx=+btn.dataset.i; var arr=CONFIG.bySystem[activeSysForEdit].fields; var name=arr[idx];
  if(confirm('Delete field "'+name+'"?')){
    arr.splice(idx,1); saveAll(); renderEdit();
    if(systemSel.value===activeSysForEdit && monthSel.value) buildMonthly();
    if(systemSel.value===activeSysForEdit && dateSel.value) renderDaily();
  }
});
fieldList.addEventListener('input', function(ev){
  var ip=ev.target.closest('input.fdName'); if(!ip) return;
  var idx=+ip.dataset.i; CONFIG.bySystem[activeSysForEdit].fields[idx]=ip.value; saveAll();
  if(systemSel.value===activeSysForEdit && monthSel.value) buildMonthly();
  if(systemSel.value===activeSysForEdit && dateSel.value) renderDaily();
});

/* ===== Export/Import/Print ===== */
btnExportJSON.addEventListener('click', function(){
  var blob=new Blob([JSON.stringify({CONFIG,DB},null,2)],{type:'application/json'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='daily_test_log_backup.json'; a.click(); URL.revokeObjectURL(a.href);
});
btnExportCSV.addEventListener('click', function(){
  var sys=systemSel.value, ym=monthSel.value; if(!sys||!ym){ alert('Choose system & month'); return; }
  var cfg = CONFIG.bySystem[sys] || {points:[],fields:[]};
  var points=cfg.points, fields=cfg.fields; var days=new Date(+ym.slice(0,4),+ym.slice(5,7),0).getDate();
  var headers=['Date']; points.forEach(function(p){fields.forEach(function(f){headers.push(p+' — '+f);});}); var lines=[headers.join(',')];
  for(var d=1; d<=days; d++){
    var ds=String(d).padStart(2,'0'); var dateStr=ym+'-'+ds; var row=(DB[sys]&&DB[sys][ym]&&DB[sys][ym][ds])||{}; var cells=[dateStr];
    points.forEach(function(pt){fields.forEach(function(fd){
      var v=(row[pt]&&row[pt][fd]!=null)?String(row[pt][fd]):''; cells.push(/[" ,\n]/.test(v)?('"'+v.replace(/"/g,'""')+'"'):v);
    });});
    lines.push(cells.join(','));
  }
  var blob=new Blob([lines.join('\n')],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=sys+' '+ym+'.csv'; a.click(); URL.revokeObjectURL(a.href);
});
btnExportXLS.addEventListener('click', function(){
  var sys=systemSel.value, ym=monthSel.value; if(!sys||!ym){ alert('Choose system & month'); return; }
  var cfg = CONFIG.bySystem[sys] || {points:[],fields:[]};
  var points=cfg.points, fields=cfg.fields; var days=new Date(+ym.slice(0,4),+ym.slice(5,7),0).getDate();
  var html = '<html><head><meta charset="utf-8"></head><body><table border="1"><tr><th>Date</th>';
  points.forEach(function(p){fields.forEach(function(f){ html+='<th>'+esc(p)+' - '+esc(f)+'</th>'; });}); html+='</tr>';
  for(var d=1; d<=days; d++){
    var ds=String(d).padStart(2,'0'); var dateStr=ym+'-'+ds; var row=(DB[sys]&&DB[sys][ym]&&DB[sys][ym][ds])||{};
    html+='<tr><td>'+esc(dateStr)+'</td>'; points.forEach(function(pt){fields.forEach(function(fd){
      var v=(row[pt]&&row[pt][fd]!=null)?String(row[pt][fd]):''; html+='<td>'+esc(v)+'</td>';
    });}); html+='</tr>';
  }
  html+='</table></body></html>';
  var blob=new Blob([html],{type:'application/vnd.ms-excel'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=sys+' '+ym+'.xls'; a.click(); URL.revokeObjectURL(a.href);
});
btnExportPDF.addEventListener('click', function(){
  var sys=systemSel.value, ym=monthSel.value; if(!sys||!ym){ alert('Choose system & month'); return; }
  var cfg = CONFIG.bySystem[sys] || {points:[],fields:[]};
  var points=cfg.points, fields=cfg.fields; var days=new Date(+ym.slice(0,4),+ym.slice(5,7),0).getDate();
  var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>'+esc(sys)+' '+esc(ym)+' Report</title>'
  +'<style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;}h1{font-size:18px;margin:0 0 12px}table{width:100%;border-collapse:collapse}'
  +'th,td{border:1px solid #000;padding:6px 8px;font-size:12px;text-align:center}th{background:#eee}.meta{margin:0 0 12px;font-size:12px}</style></head><body>';
  html += '<h1>'+esc(sys)+' — '+esc(ym)+' Report</h1><div class="meta">Generated '+new Date().toLocaleString()+'</div><table><tr><th>Date</th>';
  points.forEach(function(p){fields.forEach(function(f){ html+='<th>'+esc(p)+' - '+esc(f)+'</th>'; });}); html+='</tr>';
  for(var d=1; d<=days; d++){
    var ds=String(d).padStart(2,'0'); var dateStr=ym+'-'+ds; var row=(DB[sys]&&DB[sys][ym]&&DB[sys][ym][ds])||{};
    html+='<tr><td>'+esc(dateStr)+'</td>'; points.forEach(function(pt){fields.forEach(function(fd){
      var v=(row[pt]&&row[pt][fd]!=null)?String(row[pt][fd]):''; html+='<td>'+esc(v)+'</td>';
    });}); html+='</tr>';
  }
  html+='</table></body></html>';
  var w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close(); w.focus(); w.print();
});
btnPrint.addEventListener('click', function(){ window.print(); });

/* ===== Seed/Reset ===== */
btnSeed.addEventListener('click', function(){ CONFIG = deepCopy(SEED); saveAll(); refreshSystemSelect(); alert('Defaults loaded. Pick a system and date/month.'); });
btnReset.addEventListener('click', function(){
  try{
    localStorage.removeItem(CONFIG_KEY); localStorage.removeItem(DATA_KEY);
    if('serviceWorker' in navigator){
      navigator.serviceWorker.getRegistrations().then(function(regs){ regs.forEach(function(r){ r.unregister().catch(function(){}); }); });
    }
    if(window.caches && window.caches.keys){
      caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
    }
    alert('Reset complete. Reloading...'); location.reload();
  }catch(e){ alert('Reset error: '+e.message); }
});

/* ===== System & Date/Month wiring ===== */
systemSel.addEventListener('change', function(){
  if(dateSel.value) renderDaily();
  if(monthSel.value) buildMonthly();
});
dateSel.addEventListener('change', renderDaily);
btnBuild.addEventListener('click', buildMonthly);

/* ===== Init ===== */
(function init(){
  refreshSystemSelect();
  var now=new Date();
  // default Daily view
  setActiveTab('daily');
  // date default today
  var m=now.getMonth()+1, d=now.getDate();
  dateSel.value = now.getFullYear()+'-'+String(m).padStart(2,'0')+'-'+String(d).padStart(2,'0');
  // month default
  monthSel.value = now.toISOString().slice(0,7);
})();
</script>
</body>
</html>
